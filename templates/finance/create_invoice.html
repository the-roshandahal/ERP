{% include 'header.html' %}

<div class="hk-pg-wrapper pb-0">
    <div class="hk-pg-body py-0">
        <div class="invoiceapp-wrap invoiceapp-setting-active">
            <div class="invoice-body">
                <div class="container">
                    <div class="create-invoice-wrap mt-xxl-5 p-md-5 p-3">
                        
                        <form action="{% url 'create_invoice' %}" method="POST">
                            {% csrf_token %}
                            <div class="row mb-3">
                                <div class="col-xxl-6 mb-xxl-0">
                                    <h6>Billed To</h6>
                                    <div class="form-group">
                                        <select class="form-select" name="customer" required>
                                            <option value="">Select Customer</option>
                                            {% for customer in customer %}
                                            <option value = '{{customer.id}}'>{{customer.client_name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <h5>Products</h5>
                            <div class="row mb-3" id="items">
                                <div class="row testing">
                                    <div class="col-xxl-3 mb-xxl-0">
                                        <h6>Select Product/Service</h6>
                                        <div class="form-group">
                                            <select class="form-select packageS" name="selected_product" id="packageS">
                                                <option value="" data-id="0" selected>Select Product/Service</option>
                                                {% for product in product %}
                                                <option value="{{product.id}}" data-id="{{product.product_price}}">{{product.product_batch}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
    
                                    <div class="col-xxl-3 mb-xxl-0">
                                        <h6>Amount Rs.</h6>
                                        <input type="number" class="form-control amountNew" id="productAmount" placeholder="Amoufsdfsdsnt" name = "selected_product_amount" value=0>
                                    </div>
    
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Quantity</h6>
                                        <input type="text" class="form-control quantityNew" id="quantity" placeholder="Quantity" name = "selected_product_quantity" value=1>
                                    </div>
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Discount</h6>
                                        <input type="text" class="form-control discountNew" id="discount" placeholder="Quantity" name = "selected_product_discount" value=0>
                                    </div>
                                    
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Total</h6>
                                        <input type="number" class="form-control totalNew" id="total" placeholder="Total" disabled>
                                    </div>
                                </div>
                                  
                                  
                                
                            </div>
                            <div class="row">
                                <div class="col text-start">
                                    <a class="d-inline-flex align-items-center" id='add'>
                                        <i class="ri-add-box-line me-1"></i> Add More
                                    </a>
                                </div>
                                
                            </div>







                            <h5>Services</h5>
                            <div class="row mb-3" id="itemsService">
                                <div class="row testing">
                                    <div class="col-xxl-3 mb-xxl-0">
                                        <h6>Select Service</h6>
                                        <div class="form-group">
                                            <select class="form-select packageService" name="selected_service" id="packageService">
                                                <option value="" data-id="0" selected>Select Service</option>
                                                {% for service in service %}
                                                <option value="{{service.id}}" data-id="{{service.service_price}}">{{service.service_title}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
    
                                    <div class="col-xxl-3 mb-xxl-0">
                                        <h6>Amount Rs.</h6>
                                        <input type="number" class="form-control amountNewService" id="serviceAmount" placeholder="Amoufsdfsdsnt" name = "selected_service_amount" value=0>
                                    </div>
    
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Quantity</h6>
                                        <input type="text" class="form-control quantityNewService" id="quantity" placeholder="Quantity" name = "selected_service_quantity" value=1>
                                    </div>
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Discount</h6>
                                        <input type="text" class="form-control discountNewService" id="discount" placeholder="Quantity" name = "selected_service_discount" value=0>
                                    </div>
                                    
                                    <div class="col-xxl-2 mb-xxl-0">
                                        <h6>Total</h6>
                                        <input type="number" class="form-control totalNewService" id="total" placeholder="Total" disabled>
                                    </div>
                                </div>
                                  
                                  
                                
                            </div>
                            <div class="row">
                                <div class="col text-start">
                                    <a class="d-inline-flex align-Service-center" id='addService'>
                                        <i class="ri-add-box-line me-1"></i> Add More
                                    </a>
                                </div>
                                
                            </div>






                            <div class="row mb-3">
                                <div class="col-xxl-6">
                                    <h6 class="float-right">Sub Total</h6>
                                </div>
                                <div class="col-xxl-6">
                                    <input type="text" class="form-control"  disabled id="subtotal" >
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-xxl-6">
                                    <h6>Miscellaneous</h6>
                                    <input type="text" class="form-control" name = "misc_name">
                                </div>
                                <div class="col-xxl-6">
                                    <h6>Miscellaneous Amount</h6>
                                    <input type="number"
                                    class="form-control"
                                    id="misc_amount_id"
                                    placeholder="Miscellaneous Amount"
                                    name = "misc_amount"
                                    min=0
                                    value = 0>
                                </div>
                            </div>
                            
                            

                            <div class="row mb-3">
                                <div class="col-xxl-6">
                                    <h6>Total</h6>
                                </div>
                                <div class="col-xxl-6">
                                    <input type="text" class="form-control" placeholder="Disabled" disabled id="totalAmt">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-xxl-6">
                                    <h6>Due Date</h6>
                                </div>
                                <div class="col-xxl-6">
                                    <input type="date" class="form-control" placeholder="Due Date" name="due_date" required value="{{ due_date }}">
                                </div>
                                
                            </div>
                            <div class="row mb-3">
                                <div class="col-xxl-6">
                                    <h6>Remarks</h6>
                                </div>
                                <div class="col-xxl-6">
                                    <textarea class="form-control" rows="6" placeholder="Write an internal note" name="remarks"></textarea>
                                </div>
                            </div>
                            <a href="#" ><button class="btn btn-primary ms-2 d-sm-inline-block d-none">Create Invoice</button></a>
                        </form>
                    </div>
                </div>
                
            <div>

        </div>
    </div>
</div>

    
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
     <script>
        $(document).ready(function() {
            $(".delete").hide();
            //when the Add Field button is clicked
            $("#add").click(function(e) {
              $(".delete").fadeIn("1500");
              //Append a new row of code to the "#items" div
              $("#items").append(
                '<div class="row testing"><div class="next-referral mb-3 row"><div class="col-xxl-3 mb-xxl-0"><h6>Select Product/Service</h6><div class="form-group"><select class="form-select packageS" name="selected_product" id="packageS"><option value="" data-id="0" selected>Select Product/Service</option>{% for product in product %}<option value="{{product.id}}" data-id="{{product.product_price}}">{{product.product_batch}}</option>{% endfor %}</select></div></div><div class="col-xxl-3 mb-xxl-0"><h6>Amount</h6><input type="number" class="form-control amountNew" id="amount" placeholder="Amount" name = "selected_product_amount"></div><div class="col-xxl-2 mb-xxl-0"><h6>Quantity</h6><input type="text" class="form-control quantityNew" id="quantity" placeholder="Quantity" name = "selected_product_quantity" value=1></div><div class="col-xxl-2 mb-xxl-0"><h6>Discount</h6><input type="text" class="form-control discountNew" id="discount" placeholder="Quantity" name = "selected_product_discount" value=0></div><div class="col-xxl-2 mb-xxl-0"><h6>Total</h6><input type="number" class="form-control totalNew" id="total" placeholder="Total" name="total" disabled></div><div class="row"><div class="col text-end"><a class="d-inline-flex align-items-center delete"><i class="ri-scissors-cut-line me-1"></i> Remove</a></div></div></div></div>'
              );
            });
            $("body").on("click", ".delete", function(e) {
                console.log('click on delete');
              $(this).closest('.next-referral').remove();
              calculateSubTotal();
            });

            $(document).on('change','.packageS',function(){
                console.log('sdfasdf');
                var selected=$(this).closest('.packageS').find(":selected").data('id');
                $(this).closest('.testing').find(".amountNew").val(selected);
                var quantity=$(this).closest('.testing').find(".quantityNew").val();
                var discount=$(this).closest('.testing').find(".discountNew").val();
                var total=(parseFloat(selected)*parseFloat(quantity)) -parseFloat(discount);  
                $(this).closest('.testing').find(".totalNew").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.amountNew',function(){
                var quantity=$(this).closest('.testing').find(".quantityNew").val();
                var discount=$(this).closest('.testing').find(".discountNew").val();
                var total=(parseFloat(quantity)*parseFloat($(this).val()))-parseFloat(discount);
                $(this).closest('.testing').find(".totalNew").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.discountNew',function(){
                var quantity=$(this).closest('.testing').find(".quantityNew").val();
                var amount=$(this).closest('.testing').find(".amountNew").val();
                var total=(parseFloat(quantity)*parseFloat(amount))-parseFloat($(this).val());
                $(this).closest('.testing').find(".totalNew").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.quantityNew',function(){
               
                var amt=$(this).closest('.testing').find(".amountNew").val();
                var discount=$(this).closest('.testing').find(".discountNew").val();
                var total=(parseFloat(amt)*parseFloat($(this).val()))-parseFloat(discount);
                $(this).closest('.testing').find(".totalNew").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','#misc_amount_id',function(){
                calculateTotal()
            })
             function calculateSubTotal(){
                var sum = 0;
                $('.totalNew').each(function(){
                    sum += parseFloat($(this).val());
                });
                console.log(sum,'1');
                $('.totalNewService').each(function(){
                    if(!isNaN(parseFloat($(this).val()))){

                        sum += parseFloat($(this).val());
                    }
                });
                console.log(sum,'2');
                $('#subtotal').val(sum);
                calculateTotal();
            } 
            {% comment %} $(document).on('keyup','#disAmt',function(){
                calculateTotal()
            }) {% endcomment %}

            function calculateTotal(){
                $disAmt=parseFloat($('#misc_amount_id').val());
                $subtotal=parseFloat($('#subtotal').val());
                var total= $subtotal+$disAmt;
                $('#totalAmt').val(total);
            }
          });
    </script>
    <script>
        $(document).ready(function() {
            $(".delete").hide();
            //when the AddService Field button is clicked
            $("#addService").click(function(e) {
              $(".delete").fadeIn("1500");
              //Append a new row of code to the "#items" div
              $("#itemsService").append(
                '<div class="row testing"><div class="next-referral mb-3 row"><div class="col-xxl-3 mb-xxl-0"><h6>Select service/Service</h6><div class="form-group"><select class="form-select packageService" name="selected_service" id="packageService"><option value="" data-id="0" selected>Select service/Service</option>{% for service in service %}<option value="{{service.id}}" data-id="{{service.service_price}}">{{service.service_title}}</option>{% endfor %}</select></div></div><div class="col-xxl-3 mb-xxl-0"><h6>Amount</h6><input type="number" class="form-control amountNewService" id="amount" placeholder="Amount" name = "selected_service_amount"></div><div class="col-xxl-2 mb-xxl-0"><h6>Quantity</h6><input type="text" class="form-control quantityNewService" id="quantity" placeholder="Quantity" name = "selected_service_quantity" value=1></div><div class="col-xxl-2 mb-xxl-0"><h6>Discount</h6><input type="text" class="form-control discountNewService" id="discount" placeholder="Quantity" name = "selected_service_discount" value=0></div><div class="col-xxl-2 mb-xxl-0"><h6>Total</h6><input type="number" class="form-control totalNewService" id="total" placeholder="Total" name="total" disabled></div><div class="row"><div class="col text-end"><a class="d-inline-flex align-items-center delete"><i class="ri-scissors-cut-line me-1"></i> Remove</a></div></div></div></div>'
              );
            });
            $("body").on("click", ".delete", function(e) {
                console.log('click on delete');
              $(this).closest('.next-referral').remove();
              calculateSubTotal();
            });

            $(document).on('change','.packageService',function(){
                console.log('cjamge');
                var selected=$(this).closest('.packageService').find(":selected").data('id');
                $(this).closest('.testing').find(".amountNewService").val(selected);
                var quantity=$(this).closest('.testing').find(".quantityNewService").val();
                var discount=$(this).closest('.testing').find(".discountNewService").val();
                var total=(parseFloat(selected)*parseFloat(quantity)) -parseFloat(discount);  
                $(this).closest('.testing').find(".totalNewService").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.amountNewService',function(){
                var quantity=$(this).closest('.testing').find(".quantityNewService").val();
                var discount=$(this).closest('.testing').find(".discountNewService").val();
                var total=(parseFloat(quantity)*parseFloat($(this).val()))-parseFloat(discount);
                $(this).closest('.testing').find(".totalNewService").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.discountNewService',function(){
                var quantity=$(this).closest('.testing').find(".quantityNewService").val();
                var amount=$(this).closest('.testing').find(".amountNewService").val();
                var total=(parseFloat(quantity)*parseFloat(amount))-parseFloat($(this).val());
                $(this).closest('.testing').find(".totalNewService").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','.quantityNewService',function(){
               
                var amt=$(this).closest('.testing').find(".amountNewService").val();
                var discount=$(this).closest('.testing').find(".discountNewService").val();
                var total=(parseFloat(amt)*parseFloat($(this).val()))-parseFloat(discount);
                $(this).closest('.testing').find(".totalNewService").val(total);
                calculateSubTotal()
            });
            $(document).on('keyup','#misc_amount_id',function(){
                calculateTotal()
            })
             function calculateSubTotal(){
                console.log('calSthited');
                var sum = 0;
                $('.totalNewService').each(function(){
                    console.log('serve'+$(this).val());
                    sum += parseFloat($(this).val());
                });
                $('.totalNew').each(function(){
                    if(parseFloat($(this).val())){
                        console.log('sdfiksadjfkjhsadifjhikjfsdfdf');

                        sum += parseFloat($(this).val());
                    }
                });
                
                $('#subtotal').val(sum);
                calculateTotal();
            } 
            {% comment %} $(document).on('keyup','#disAmt',function(){
                calculateTotal()
            }) {% endcomment %}

            function calculateTotal(){
                $disAmt=parseFloat($('#misc_amount_id').val());
                $subtotal=parseFloat($('#subtotal').val());
                var total= $subtotal+$disAmt;
                $('#totalAmt').val(total);
            }
          });
    </script>

<!-- /Main Content -->
{% include 'footer.html' %}



